name: Demo Tests CI/CD

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select environment to run tests'
        required: true
        default: 'local'
        type: choice
        options:
          - local
          - staging
          - production
      test_tag:
        description: 'Test tag to run (leave blank to run all tests)'
        required: false
        type: string
      workers:
        description: 'Number of workers'
        required: false
        default: '2'
        type: string
      retries:
        description: 'Number of retries for failed tests'
        required: false
        default: '1'
        type: string

jobs:
  test:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.19.0'

      - name: Install dependencies
        run: npm install

      - name: Install Playwright
        run: npx playwright install

      - name: Run tests
        env:
          ENV_NAME: ${{ inputs.environment }}
        run: |
          WORKERS="${{ inputs.workers }}"
          RETRIES="${{ inputs.retries }}"
          
          if [ -z "$WORKERS" ]; then
            WORKERS="2"
          fi
          
          if [ -z "$RETRIES" ]; then
            RETRIES="1"
          fi
          
          if [ -z "${{ inputs.test_tag }}" ]; then
            echo "Running all tests with $WORKERS workers and $RETRIES retries..."
            npx playwright test --workers=$WORKERS --retries=$RETRIES
          else
            echo "Running tests with tag: ${{ inputs.test_tag }}, $WORKERS workers and $RETRIES retries..."
            npx playwright test -g "${{ inputs.test_tag }}" --workers=$WORKERS --retries=$RETRIES
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ inputs.environment }}
          path: playwright-report/
          retention-days: 30

      - name: Publish test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ inputs.environment }}
          path: test-results/
          retention-days: 30
